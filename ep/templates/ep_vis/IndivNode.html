<!-- Example code that is generated by Paul's visualisation code; 27.07.2016 -->
<!-- Doing: changing the html to use template structure that works with replacements of paterns-->

{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}

{% block css %}
    <link rel="stylesheet" href='{% static "css/bootstrap.min.css" %}'>
    <link rel="stylesheet" href='{% static "css/starter-template.css" %}'>
    <link rel="stylesheet" href='{% static "css/dc.css" %}'>

    <script src='{% static "js/crossfilter.v1.min.js" %}'></script>
    <script src='{% static "js/d3.v3.js" %}'></script>
    <script src='{% static "js/dc.js" %}'></script>
    <script src='{% static "js/jquery-1.11.2.js" %}'></script>
    <script src='{% static "js/bootstrap.js" %}'></script

{% endblock css %}

{#
<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
#}
    <title>Initial IODiCUS Experiments</title>

    <!--
    Problem:
    IF path to file is: href="../../lib/css/bootstrap.min.css"
    THEN Pycharm finds it, but Chrome states
    "GET http://127.0.0.1:8000/lib/css/bootstrap.min.css "

    IF path to file is: href="ep/lib/css/bootstrap.min.css"
    THEN Chrome seems to find it, via http://127.0.0.1:8000/vis/ep/lib/css/bootstrap.min.css
    but Pycharm shows "cannot resovle file" error
    -->

{#    <link type="text/css" href="lib/css/bootstrap.min.css" rel="stylesheet">
    <link type="text/css" href="../../lib/css/starter-template.css" rel="stylesheet">
    <link type="text/css" href="../../lib/css/dc.css" rel="stylesheet">#}

<style type="text/css">

        p {
            font-size:12px;
            font-weight:normal;
        }

        li {
            font-size:12px;
            font-weight:normal;
        }

        h2 span {
            font-size:14px;
            font-weight:normal;
        }

        h4 span {
            font-size:14px;
            font-weight:normal;
        }

        .dc-chart g.row text {fill: black;}

        .node-detail-headings {
            font-size:14px;
            font-weight:bold;
        }

        .node-detail-values {
            font-size:14px;
            font-weight:normal;
        }

        .node-selected a {
            font-size:14px;
            font-weight:bold;
            color: red;

        }

        .node-selected {
            font-size:14px;
            font-weight:bold;
            color: red;

        }

        #node-details {
            margin-top: 30px;
            margin-right: 100px;
            margin-bottom: 10px;
            margin-left: 100px;
        }

        #node-list {
            margin-top: 30px;
            margin-right: 5px;
            margin-bottom: 10px;
            margin-left: 5px;
        }

        #node-charts {
            margin-top: 10px;
            margin-right: 100px;
            margin-bottom: 20px;
            margin-left: 50px;
        }

        .node-details-row {
            height: 25px;
        }

        #node-detail-table {
            width: 700px;
            cellspacing: 5px;
            cellpadding: 10px;
        }

        path {
            stroke: steelblue;
            stroke-width: 2;
            fill: none;

        }

        .grid .tick {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }

        .navigator .data {
            fill: lightgrey;
            stroke-width: 0px;
        }

        .navigator .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1px;
        }


        .navigator .viewport {
            stroke: grey;
            fill: black;
            fill-opacity: 0.2;
        }

        .chart .overlay {
            stroke-width: 0px;
            fill-opacity: 0;
        }

        #list-nav ul{height:500px; width:100%;}
        #list-nav ul{overflow:hidden; overflow-y:scroll;}

        .legend {
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
        }


    </style>

    {#<script type="text/javascript" src="../../lib/js/crossfilter.v1.min.js"></script>
    <script type="text/javascript" src="../../lib/js/d3.v3.js"></script>
    <script type="text/javascript" src="../../lib/js/dc.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-1.11.2.js"></script>
    <script type="text/javascript" src="../../lib/js/bootstrap.js"></script>
#}
    <title>Flask Data Test</title>
</head>

<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../">Initial IODiCUS Experiments</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">

            <ul class="nav navbar-nav">
                <li class="active"><a href="../">Demo Home</a></li>
                <!--
                <li><a href="getting-started.html">Getting Started</a></li>
                <li><a href="analyseyourdata.html">Analyse Your Data</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                -->
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<div>
    <div class="row">
        <div class="row">
           <div class="col-md-12">
               <div class="col-md-2" id="node-list">
                   <p class="node-detail-headings">Node List</p>
                   <div id="list-nav">

                       <ul id="nodeList">

                       </ul>

                   </div>
               </div>
               <div class="col-md-8">
                   <div class="row">
                        <div class="col-md-8">
                            <div id="node-details">

                                <h1>Node Details</h1>
                                <table id="node-detail-table">
                                    <tr class="node-details-row">
                                        <td ><span class="node-detail-headings">BMS:</span> <span class="node-detail-values" id="bms"></span></td>
                                        <td><span class="node-detail-headings">NodeID:</span> <span class="node-detail-values" id="node-id"></span></td>
                                        <td><span class="node-detail-headings">BASIC NODE STATISTICS</span></td>
                                    </tr>
                                    <tr class="node-details-row">
                                        <td ><span class="node-detail-headings">Space Name:</span> <span class="node-detail-values" id="node-name"></span></td>
                                        <td><span class="node-detail-headings">Node Type:</span> <span class="node-detail-values" id="node-type"></span></td>
                                        <td><span class="node-detail-headings">Temp (Min-Max): </span><span id="min-temp"></span> - <span id="max-temp"></span>ºC</td>
                                    </tr>
                                    <tr class="node-details-row">
                                        <td><span class="node-detail-headings">Site:</span> <span class="node-detail-values" id="site"></span></td>
                                        <td><span class="node-detail-headings">Node Power (Watts):</span> <span class="node-detail-values" id="power-w"></span></td>
                                        <td><span class="node-detail-headings">Temp Range: </span><span id="temp-range"></span> ºC</td>
                                    </tr>
                                    <tr class="node-details-row">
                                        <td><span class="node-detail-headings">Building:</span> <span class="node-detail-values" id="building"></span></td>
                                        <td></td>
                                        <td><span class="node-detail-headings">Total Energy: </span><span id="total-energy"></span> kWh</td>
                                    </tr>
                                    <tr class="node-details-row">
                                        <td><span class="node-detail-headings">Storey:</span> <span class="node-detail-values" id="storey"></span></td>
                                    </tr>
                                </table>

                            </div>
                        </div>

                   </div>

               <div class="row">

                   <div class="col-md-8">
                       <div id="node-charts"></div>
                   </div>

               </div>


            </div>

        </div>


    </div>
</div>

<script>

    // get data from fask
    var metadata = [{"Building": "uob-demo-5", "index": 224, "NodeType": "Room Heater", "Space": "uob-demo-5-3-9", "Site": "uob-demo", "Storey": "uob-demo-5-3", "NodeSignature": "2010177a", "BMS": "demo-BMS", "PowerW": 1000, "NodeAddress": 6010, "SpaceName": "d-5-3-9"}];    // building metadata
    var data = [{"Temperature": 13.1, "DateTime": "2016-06-03 00:31:00"}, {"Temperature": 13.1, "DateTime": "2016-06-03 00:25:31"}, {"Temperature": 13.2, "DateTime": "2016-06-03 00:20:56"}, {"Temperature": 13.2, "DateTime": "2016-06-03 00:15:28"}, {"Temperature": 13.2, "DateTime": "2016-06-03 00:10:53"}, {"Temperature": 13.2, "DateTime": "2016-06-03 00:05:24"}, {"Temperature": 13.2, "DateTime": "2016-06-03 00:00:50"}]; // external temperature

    console.log(metadata);
    console.log(data);
    console.log(space);
    console.log(nodedata);
    console.log(externaltemp);


    // Draw list of nodes and annimate to current value

    drawTable(nodedata);

    currentNode(space);
    selectedNode = "#" + String(space);
    console.log(selectedNode);
    $("#nodeList").animate({scrollTop:$(selectedNode).position().top - 100}, 'slow');

    // Add data to the node information table

    $("#node-name").text(metadata[0].SpaceName);
    $("#node-id").text(metadata[0].SpaceName);
    $("#site").text(metadata[0].Site);
    $("#building").text(metadata[0].Building);
    $("#storey").text(metadata[0].Storey);
    $("#node-type").text(metadata[0].NodeType);
    $("#power-w").text(metadata[0].PowerW);
    $("#bms").text(metadata[0].BMS);


    // get some stats

    var maxTemp = d3.max(data, function(d) { return d.Temperature; });
    maxTemp = maxTemp.toFixed(1);
    var minTemp = d3.min(data, function(d) { return d.Temperature; });
    minTemp= minTemp.toFixed(1);

    energyTotal = ((d3.sum(data, function(d) { return d.EnergyWh; }))/1000).toFixed(1);

    $("#max-temp").text(maxTemp);
    $("#min-temp").text(minTemp);
    tempRange = (maxTemp-minTemp).toFixed(1);
    $("#temp-range").text(tempRange);
    $("#total-energy").text(energyTotal);



    // Set up primary chart

    // Set dimentions of the chart area
    var margin = {top: 20, right: 80, bottom: 30, left: 100},
            width = 1000 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;

    // Parse DateTime
    var parseDate = d3.time.format("%Y-%m-%d %H:%M:%S").parse;

    // Set ranges
    var xScale = d3.time.scale()
            .range([0, width]);

    var yScale = d3.scale.linear()
            .range([height, 0]);

    // Define axes

    var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom");

    var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left");

    // Define the line

    var line = d3.svg.line()
            .interpolate("basis")
            .x(function(d) { return xScale(d.DateTimeRecieved); })
            .y(function(d) { return yScale(d.Temperature); });

    // Add the svg canvas

    var plotChart = d3.select("#node-charts").classed('chart', true).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // plotArea to enable clipping when the x-axis is rescalled
    var plotArea = plotChart.append('g')
            .attr('clip-path', 'url(#plotAreaClip)');

    plotArea.append('clipPath')
            .attr('id', 'plotAreaClip')
            .append('rect')
            .attr({ width: width, height: height });




    // Set up grid lines

    function make_x_axis() {
        return d3.svg.axis()
                .scale(xScale)
                .orient("bottom");
                //.ticks(5)
    }

    function make_y_axis() {
        return d3.svg.axis()
                .scale(yScale)
                .orient("left");
                //.ticks(5)
    }


    // convert Relay = Boolean to Int for plotting
    function relayOn(d) {
        if (d.L2Relay == "True") {
            return 1
        }
        else {
            return 0
        }
    }



    // parse datetime and temperature
    data.forEach(function(d) {
        d.DateTimeRecieved = parseDate(d.DateTimeRecieved);
        d.Temperature = +d.Temperature;
        d.RelayOn = d.L2Relay; // relayOn(d);

    });


    //console.log(data);

    // Define the temperature line
    var valuelinetemp = d3.svg.line()
            .x(function(d) { return xScale(d.DateTimeRecieved); })
            .y(function(d) { return yScale(d.Temperature); });



//    var valuelinesetpoint = d3.svg.line()
//            .x(function(d) { return xScale(d.DateTimeRecieved); })
//            .y(function(d) { return yScale(d.TempSetPoint); });


    // Min and Max values

    var minN = d3.min(data, function (d) { return d.DateTimeRecieved; }).getTime(),
            maxN = d3.max(data, function (d) { return d.DateTimeRecieved; }).getTime();
    var minDate = new Date(minN ),
            maxDate = new Date(maxN );
    var yMin = d3.min(data, function (d) { return d.Temperature; }),
            yMax = d3.max(data, function (d) { return d.Temperature; });
    //console.log(minDate, maxDate, yMin, yMax);

    // Scale the range of the data

    xScale.domain([minDate, maxDate]);
    yScale.domain([0, d3.max(data, function(d) { return d.Temperature; })+10 ]);

    // Add the X and Y axis

    plotChart.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .style("font-size","10px")
            .call(xAxis);
            //.append("text")
            //.attr("transform", "translate(" + width/2 + "," + 35 + ")")
            //.style("text-anchor", "middle")
            //.style("font-size","12px")
            //.text("Date");

    plotChart.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .style("font-size","10px")
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", -45)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .style("font-size","12px")
            .text("Temperature (ºC)");

    // Add grid lines

    plotChart.append("g")
            .attr("class", "grid")
            .attr("transform", "translate(0," + height + ")")
            .call(make_x_axis()
                    .tickSize(-height, 0, 0)
                    .tickFormat("")
    );

    plotChart.append("g")
            .attr("class", "grid")
            .call(make_y_axis()
                    .tickSize(-width, 0, 0)
                    .tickFormat("")
    );


    // add the temperature line
    tempSeriesPlot = plotArea.append("path")
            .attr("class", "line")
            .attr("d", valuelinetemp(data));


    // add the setpoint line
    //svg.append("path")
    //        .attr("class", "line")
    //        .style("stroke", "orange")
    //        .attr("d", valuelinesetpoint(data));


    // add temperature setpoints as rectangles
    setPointSeriesPlot = plotArea.selectAll("rect") // if temp adjusted one colour if not another
            .data(data)
            .enter().append("rect")
            //.filter(function(d) { return d.close < 400 }) // <== This line
            .style("fill", function(d) {
                if (d.TempAdjusted == 0) {
                    return "red"
                } else {
                    return "darkred"
                }
            })
            .attr("width", 1.5)
            .attr("height", 3.5)
            .attr("x", function(d) { return xScale(d.DateTimeRecieved); })
            .attr("y", function(d) { return yScale(d.TempSetPoint); });

    l2SeriesPlot = plotArea.selectAll("l2r")
            .data(data)
            .enter().append("rect")
        //.filter(function(d) { return d.close < 400 }) // <== This line
            .style("fill", "orange")
            .attr("width", 1.5)
            .attr("height", 3.5)
            .attr("x", function(d) { return xScale(d.DateTimeRecieved); })
            .attr("y", function(d) { return yScale(d.RelayOn * 4); });


    //Program Charts

    //TODO doesn't update on zoom from main chart

    var progNest = d3.nest()
            .key(function(d) {
                return d.ProgramName;})
            .entries(data);

    progCount = (progNest.length);
    progNameValue = {};
    for (i = 0; i<progCount; i++)
    {
        progNameValue[progNest[i].key] = i+1
    };
    //console.log(progNest[0].key);
    console.log(progNameValue)


    var progWidth = width;
    var progHeight = progCount * 30 ;


    var progChart = d3.select('#node-charts').classed('chart', true).append('svg')
            .classed('prog', true)
            .attr('width', progWidth + margin.left + margin.right)
            .attr('height', progHeight )
            .append('g')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');


    // progArea to enable clipping when the x-axis is rescalled
    var progArea = progChart.append('g')
            .attr('clip-path', 'url(#progAreaClip)');

    progArea.append('clipPath')
            .attr('id', 'progAreaClip')
            .append('rect')
            .attr({ width: progWidth, height: progHeight });


    var progXScale = d3.time.scale()
            .domain([minDate, maxDate])
            .range([0, progWidth]);

    var progYScale = d3.scale.linear()
            .domain([0, progCount])
            .range([progHeight, 0]);

    var progXAxis = d3.svg.axis()
            .scale(progXScale)
            .orient('bottom');

//    progChart.append('g')
//            .attr('class', 'xScale axis')
//            .attr('transform', 'translate(0,' + progHeight + ')')
//            .call(progXAxis);

    var progData = d3.svg.area()
            .x(function (d) { return progXScale(d.DateTimeRecieved); })
            .y0(navHeight)
            .y1(function (d) {
                progNameValue(d.ProgramName)

            });

    var progLine = d3.svg.line()
            .x(function (d) { return progXScale(d.DateTimeRecieved); })
            .y(function (d) { return progYScale(
                    progNameValue[d.ProgramName]
            ); });


    progChartPlot = progArea.append('path')
            .attr('class', 'line')
            .style("stroke", "green")
            .attr('d', progLine(data));


    for (i = 0; i < progCount; i++) {
        progChart.append("text") //
                .attr("x",-4)
                .attr("y", progYScale(i+1)) //

                .attr("class", "prog-y-axis") // style the legend //
                .style("fill", "black") //
                .style("font-size","11px")
                .attr("dy", "0.3em")
                .style("text-anchor", "end")
                .text(function() { // dynamic colours // *******
                    key_name = progNest[i].key;
                    return key_name });

    }





    // TODO redraw program chart via Nav Chart


    // Lower Navigation Chart
    // ******* Approach based on <http://blog.scottlogic.com/2014/09/19/interactive.html> *******

    var navWidth = width;
    var navHeight = 100 - margin.top - margin.bottom;

    var navChart = d3.select('#node-charts').classed('chart', true).append('svg')
            .classed('navigator', true)
            .attr('width', navWidth + margin.left + margin.right)
            .attr('height', navHeight + margin.top + margin.bottom)
            .append('g')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var navXScale = d3.time.scale()
                    .domain([minDate, maxDate])
                    .range([0, navWidth]),
            navYScale = d3.scale.linear()
                    .domain([yMin, yMax])
                    .range([navHeight, 0]);

    var navXAxis = d3.svg.axis()
            .scale(navXScale)
            .orient('bottom');

    navChart.append('g')
            .attr('class', 'xScale axis')
            .attr('transform', 'translate(0,' + navHeight + ')')
            .call(navXAxis);



    var navData = d3.svg.area()
            .x(function (d) { return navXScale(d.DateTimeRecieved); })
            .y0(navHeight)
            .y1(function (d) { return navYScale(d.Temperature); });

    var navLine = d3.svg.line()
            .x(function (d) { return navXScale(d.DateTimeRecieved); })
            .y(function (d) { return navYScale(d.Temperature); });

    navChart.append('path')
            .attr('class', 'data')
            .attr('d', navData(data));

    navChart.append('path')
            .attr('class', 'line')
            .attr('d', navLine(data));


    // Nav Chart brush

    var viewport = d3.svg.brush()
            .x(navXScale)
            .on("brush", function () {
                xScale.domain(viewport.empty() ? navXScale.domain() : viewport.extent());
                progXScale.domain(viewport.empty() ? navXScale.domain() : viewport.extent());
                redrawChart();
            });


    // re-draw the chart
    function redrawChart() {
        setPointSeriesPlot
                .attr("x", function(d) { return xScale(d.DateTimeRecieved);})
                .attr("y", function(d) { return yScale(d.TempSetPoint); });
        l2SeriesPlot
                .attr("x", function(d) { return xScale(d.DateTimeRecieved); })
                .attr("y", function(d) { return yScale(d.RelayOn * 4); });
        tempSeriesPlot.attr("d", valuelinetemp(data));
        plotChart.select('.x.axis').call(make_x_axis());

        progLine = d3.svg.line()
                .x(function (d) { return progXScale(d.DateTimeRecieved); })
                .y(function (d) { return progYScale(
                        progNameValue[d.ProgramName]
                ); });

        progChartPlot.attr('d', progLine(data));

    }

    navChart.append("g")
            .attr("class", "viewport")
            .call(viewport)
            .selectAll("rect")
            .attr("height", navHeight);

    // TODO fix issue that if zoom out when first on page can zoom out beyond range <http://blog.scottlogic.com/2014/09/19/interactive.html>


    // Prevent zoom going beyond dates in data
    var zoom = d3.behavior.zoom()
            .x(xScale)
            .on('zoom', function() {
                if (xScale.domain()[0] < minDate) {
                    var x = zoom.translate()[0] - xScale(minDate) + xScale.range()[0];
                    zoom.translate([x, 0]);
                } else if (xScale.domain()[1] > maxDate) {
                    var x = zoom.translate()[0] - xScale(maxDate) + xScale.range()[1];
                    zoom.translate([x, 0]);
                }
                progXScale = xScale;
                redrawChart();
                updateViewportFromChart();
            });


    function updateViewportFromChart() {

        if ((xScale.domain()[0] <= minDate) && (xScale.domain()[1] >= maxDate)) {

            viewport.clear();
        }
        else {

            viewport.extent(xScale.domain());
        }

        navChart.select('.viewport').call(viewport);
    }

    var overlay = d3.svg.area()
            .x(function (d) { return xScale(d.DateTimeRecieved); })
            .y0(0)
            .y1(height);

    plotArea.append('path')
            .attr('class', 'overlay')
            .attr('d', overlay(data))
            .call(zoom);


    viewport.on("brushend", function () {
        updateZoomFromChart();
    });

    function updateZoomFromChart() {

        zoom.x(xScale);

        var fullDomain = maxDate - minDate,
                currentDomain = xScale.domain()[1] - xScale.domain()[0];

        var minScale = currentDomain / fullDomain,
                maxScale = minScale * 20;

        zoom.scaleExtent([minScale, maxScale]);
    }

//    // Playing with starting with a pre-selected range rather than whole thing
//    var daysShown = 3000;
//
//    xScale.domain([
//        data[data.length - daysShown - 1].DateTimeRecieved,
//        data[data.length - 1].DateTimeRecieved
//    ]);
//
//    redrawChart();
//    updateViewpointFromChart();
//    updateZoomFromChart();






    // Legend

    legendSpace = width/4; // spacing for legend //

    // Add the Legend

    legend_colours = ["steelblue", "red", "darkred", "orange" ];
    legend_labels = ["-- node temp", "-- set-point", "-- adjusted temp", "-- relay on"]
    for (i = 0; i < 4; i++) {
        plotChart.append("text") //
                .attr("x", (legendSpace/2)+i*legendSpace) // spacing //
                .attr("y", 10) //
                .attr("class", "legend") // style the legend //
                .style("fill", function() { // dynamic colours // *******
                    return legend_colours[i] }) //
                .text(function() { // dynamic colours // *******
                    return legend_labels[i] })

    }

    // Node list scripts

    function drawTable(nodedata) {
        for (var i = 0; i < nodedata.length; i++) {
            drawRow(nodedata[i]);
        }
    };


    function drawRow(rowData) {
        var row = $("<tr />");
        $("#nodeList").append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
        row.append($("<li id=" + rowData.NodeAddress + "> <a href='/space/" + rowData.SpaceName + "'>" + rowData.SpaceName + "</a></li>"));
    };

    // Highlight currently choosen node

    function currentNode(space) {
        selectedNode = "#" + String(space);
        $(selectedNode).addClass('node-selected');
        //console.log(selectedNode);
    }





</script>



</body>
</html>